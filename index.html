<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,viewport-fit=cover">
<meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="THEMT">
<meta name="theme-color" content="#8B5E3C">
<title>ADMIN THEMT</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--brown:#8B5E3C;--bl:#C4956A;--cream:#FAF7F2;--cd:#F5F0EB;--t:#333;--gr:#4CAF50;--rd:#F44336;--sb:env(safe-area-inset-bottom,8px)}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{font-family:'Sarabun',sans-serif;background:var(--cream);min-height:100vh;max-width:520px;margin:0 auto;color:var(--t);overflow-x:hidden}
input,textarea,select,button{font-family:'Sarabun',sans-serif}
::-webkit-scrollbar{width:0;height:0}
.login-page{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 24px;background:linear-gradient(160deg,#8B5E3C 0%,#C4956A 50%,#D4A574 100%)}
.login-card{background:#fff;border-radius:28px;padding:36px 28px;width:100%;max-width:380px;box-shadow:0 20px 60px rgba(0,0,0,.15)}
.login-card h2{text-align:center;color:var(--brown);font-size:22px;margin-bottom:4px}
.login-card p{text-align:center;color:#999;font-size:13px;margin-bottom:20px}
.lin{width:100%;background:#f9f6f2;border:2px solid transparent;border-radius:14px;padding:14px 16px;font-size:15px;outline:none;transition:.2s;margin-top:10px}
.lin:focus{border-color:var(--brown)}
.lbtn{width:100%;padding:16px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--brown),var(--bl));color:#fff;font-weight:700;font-size:16px;cursor:pointer;margin-top:16px}
.lerr{color:var(--rd);font-size:13px;text-align:center;margin-top:8px;min-height:18px}
.topbar{padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;background:rgba(250,247,242,.95);backdrop-filter:blur(14px);border-bottom:1px solid rgba(180,140,100,.08)}
.topbar .nm{font-weight:700;font-size:15px}
.rl{font-size:10px;padding:2px 8px;border-radius:20px;font-weight:600}
.rl-b{background:#FFF3E0;color:#E65100}.rl-a{background:#E3F2FD;color:#1565C0}
.topbar .lo{background:none;border:none;font-size:13px;color:#999;cursor:pointer}
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,252,247,.96);backdrop-filter:blur(16px);border-top:1px solid rgba(180,140,100,.1);display:flex;justify-content:space-around;padding:6px 0;padding-bottom:var(--sb);z-index:100;max-width:520px;margin:0 auto}
.nb{background:none;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;opacity:.4;transition:.2s}
.nb.ac{opacity:1;transform:scale(1.05)}.nb .ni{font-size:22px}.nb .nl{font-size:10px;font-weight:500;color:#999}.nb.ac .nl{font-weight:700;color:var(--brown)}
.pg{display:none;padding:16px 20px 100px}.pg.ac{display:block}
.card{background:#fff;border-radius:18px;padding:20px;margin-bottom:14px;box-shadow:0 2px 12px rgba(139,94,60,.06)}
.card h3{font-size:14px;color:#888;margin-bottom:8px}
.big{font-size:32px;font-weight:800;color:var(--brown)}
.sub{font-size:12px;color:#aaa;margin-top:2px}
#sBan{padding:0;font-size:11px;text-align:center;font-weight:600;overflow:hidden;transition:.3s}
.chips{display:flex;gap:8px;overflow-x:auto;padding:8px 0}
.chip{background:#fff;border:1px solid rgba(180,140,100,.15);border-radius:20px;padding:6px 14px;cursor:pointer;white-space:nowrap;font-size:12px;font-weight:500;color:#888;transition:.2s}
.chip.ac{background:var(--brown);color:#fff;border-color:var(--brown)}
.oi{background:#fff;border-radius:14px;padding:14px;margin-bottom:8px;box-shadow:0 1px 6px rgba(139,94,60,.04);display:flex;justify-content:space-between;align-items:center}
.oi .ol{flex:1}.oi .op{font-weight:700;font-size:14px}.oi .od{font-size:11px;color:#999;margin-top:2px}
.oi .opr{font-weight:800;font-size:16px;color:var(--brown);text-align:right}.oi .on{font-size:10px;color:#aaa;text-align:right}
.pg2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
.pc{background:#fff;border:2px solid transparent;border-radius:16px;padding:16px 12px;text-align:center;cursor:pointer;transition:.2s;box-shadow:0 2px 8px rgba(139,94,60,.05)}
.pc.sel{border-color:var(--brown);background:#FFF8F0;transform:scale(1.03)}
.pc .pn{font-weight:700;font-size:14px}
.fg{margin-top:14px}.fg label{font-size:13px;font-weight:600;color:#666;display:block;margin-bottom:4px}
.fi{width:100%;background:#fff;border:2px solid rgba(180,140,100,.15);border-radius:14px;padding:12px 14px;font-size:15px;outline:none;transition:.2s}
.fi:focus{border-color:var(--brown)}
textarea.fi{min-height:80px;resize:vertical}
.sbtn{width:100%;padding:16px;border-radius:16px;border:none;background:linear-gradient(135deg,var(--brown),var(--bl));color:#fff;font-weight:800;font-size:16px;cursor:pointer;margin-top:16px;box-shadow:0 6px 20px rgba(139,94,60,.25)}
.sbtn:disabled{opacity:.5}
.ac2{background:#fff;border-radius:14px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 6px rgba(139,94,60,.04)}
.si{background:#fff;border-radius:14px;padding:14px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 1px 6px rgba(139,94,60,.04)}
.abtn{background:var(--brown);color:#fff;border:none;border-radius:12px;padding:10px 20px;font-weight:700;font-size:14px;cursor:pointer}
.dbtn{background:none;border:none;color:var(--rd);font-size:13px;cursor:pointer}
.modal-bg{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:200;display:none;align-items:flex-end;justify-content:center}
.modal-bg.show{display:flex}
.modal{background:#fff;border-radius:24px 24px 0 0;padding:28px 24px;width:100%;max-width:520px;max-height:80vh;overflow-y:auto}
.modal h3{font-size:18px;font-weight:700;margin-bottom:16px;text-align:center}
.suc-ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.95);z-index:300;display:none;align-items:center;justify-content:center;flex-direction:column}
.suc-ov.show{display:flex}
.tb{background:var(--cd);color:var(--brown);padding:2px 10px;border-radius:20px;font-size:11px;font-weight:600}
.phb{padding:6px 12px;border-radius:10px;font-size:12px;font-weight:600;margin-top:6px;display:inline-block}
.phb.ok{background:#E8F5E9;color:#2E7D32}.phb.err{background:#FFEBEE;color:#C62828}
.slb{background:#f5f0eb;border:2px dashed rgba(180,140,100,.3);border-radius:14px;padding:14px;text-align:center;cursor:pointer;font-size:13px;color:#888;margin-top:10px}
.slp{max-width:120px;border-radius:12px;margin-top:8px}
</style>
</head>
<body>
<div id="loginPage" class="login-page">
  <div class="login-card">
    <h2>üß¥ ADMIN THEMT</h2>
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</p>
    <input class="lin" id="lEm" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" autocomplete="email">
    <input class="lin" id="lPn" type="password" inputmode="numeric" maxlength="4" placeholder="PIN 4 ‡∏´‡∏•‡∏±‡∏Å">
    <button class="lbtn" onclick="doLogin()">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
    <div class="lerr" id="lErr"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="topbar">
    <div><span class="nm" id="tNm">-</span> <span class="rl" id="tRl">-</span></div>
    <button class="lo" onclick="doLogout()">‡∏≠‡∏≠‡∏Å ‚Üó</button>
  </div>
  <div id="sBan"></div>
  <div class="pg" id="pg-home"></div>
  <div class="pg" id="pg-add"></div>
  <div class="pg" id="pg-orders"></div>
  <div class="pg" id="pg-settings"></div>
  <div class="bnav" id="bNav"></div>
</div>

<div class="modal-bg" id="mBg" onclick="if(event.target===this)cM()"><div class="modal" id="mC"></div></div>
<div class="suc-ov" id="sOv"><div style="font-size:48px" id="sIc"></div><div style="font-size:18px;font-weight:700" id="sMs"></div><div style="font-size:13px;color:#888;margin-top:4px;white-space:pre-line" id="sSb"></div></div>

<script>
const API="https://script.google.com/macros/s/AKfycbyQjfmt-KOnRIKOfQeZs8ZiYxTB8F14cQzGYNedURU4H8gRA-k8ovzjF9ps2oW8G1tW/exec";
const VER='v15.3';
let cu=null,orders=[],products=[],users=[],teams=[];
let selP=null,bD='',fProd='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',fAdm='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',cPg='';

// Utils
function fD(d){const dd=String(d.getDate()).padStart(2,'0'),mm=String(d.getMonth()+1).padStart(2,'0'),yy=d.getFullYear();return dd+'/'+mm+'/'+yy}
function fT(d){return d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false})}
function nD(s){return s?String(s).replace(/-/g,'/'):''}
function st(m,c){const b=document.getElementById('sBan');b.textContent=m;b.style.background=c||'#fff3cd';b.style.color=c==='#E8F5E9'?'#2E7D32':'#856404';b.style.padding=m?'6px 12px':'0';if(m)setTimeout(()=>{b.textContent='';b.style.padding='0'},5000)}
function sS(i,m,s){document.getElementById('sIc').textContent=i;document.getElementById('sMs').textContent=m;document.getElementById('sSb').textContent=s||'';document.getElementById('sOv').classList.add('show')}
function hS(){document.getElementById('sOv').classList.remove('show')}
function oM(h){document.getElementById('mC').innerHTML=h;document.getElementById('mBg').classList.add('show')}
function cM(){document.getElementById('mBg').classList.remove('show')}

// ===== CLOUD =====
async function FC(date){
  st('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  try{
    const p=date?'?date='+encodeURIComponent(date):'';
    const r=await fetch(API+p);const d=await r.json();
    if(d.error){st('‚ùå '+d.error,'#FFEBEE');return}
    if(d.products)products=d.products;
    if(d.users){users=d.users;teams=[...new Set(users.map(u=>u.team).filter(Boolean))];
      if(cu&&cu.role!=='boss'){if(!users.find(u=>u.email===cu.email&&u.pin===cu.pin)){doLogout();return}}
    }
    if(d.orders){
      const co=d.orders.map(o=>({...o,date:nD(o.date),amount:Number(o.amount)||0,phone:o.phone?String(o.phone):'',team:(users.find(u=>u.email===o.adminEmail)||{}).team||''}));
      // ‡πÄ‡∏Å‡πá‡∏ö pending 2 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡∏•‡∏ö‡∏ñ‡πâ‡∏≤ Cloud ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß (match time+amount+admin)
      const pend=orders.filter(o=>{
        if(!o._local||!o._ts)return false;
        if(Date.now()-o._ts>120000)return false; // ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ 2 ‡∏ô‡∏≤‡∏ó‡∏µ
        // ‡∏ñ‡πâ‡∏≤ Cloud ‡∏°‡∏µ order ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πá‡∏ö pending
        const dup=co.find(c=>c.time===o.time&&Math.abs(c.amount-o.amount)<1&&(c.adminName===o.adminName||c.adminEmail===o.adminEmail));
        return !dup;
      });
      orders=[...co,...pend];
    }
    st('‚úÖ Cloud:'+orders.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‚òÅÔ∏è'+((d.orders||[]).length)+')','#E8F5E9');
    rP();
  }catch(e){st('‚ùå '+e.message,'#FFEBEE')}
}
async function PC(body){
  const data=JSON.stringify(body);
  try{
    await fetch(API,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:data});
    console.log('POST sent (no-cors)');
    return true;
  }catch(e){
    console.log('POST err:',e);
    // fallback: retry once
    try{await fetch(API,{method:'POST',mode:'no-cors',headers:{'Content-Type':'text/plain'},body:data});return true}catch(e2){}
    return false;
  }
}

// ===== DEBUG: ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API =====
async function testAPI(){
  st('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö API...');
  try{
    const r=await fetch(API);const d=await r.json();
    let msg='=== API TEST ===\n';
    msg+='Products: '+(d.products?d.products.length:0)+'\n';
    msg+='Users: '+(d.users?d.users.length:0)+'\n';
    msg+='Orders: '+(d.orders?d.orders.length:0)+'\n';
    msg+='Date: '+(d.date||'?')+'\n';
    if(d.error)msg+='ERROR: '+d.error+'\n';
    if(d.orders&&d.orders.length>0){
      msg+='\n--- ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ---\n';
      d.orders.slice(0,3).forEach((o,i)=>{
        msg+=(i+1)+'. '+o.date+' | '+o.productName+' | ‡∏ø'+o.amount+' | '+o.adminName+'\n';
      });
    }
    if(d.debug){
      msg+='\n--- DEBUG ---\n';
      msg+='Target: '+d.debug.targetDate+'\n';
      msg+='Sheets: '+(d.debug.sheets||[]).join(', ')+'\n';
      if(d.debug.sampleDates&&d.debug.sampleDates.length){
        msg+='\n--- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡∏µ‡∏ó ---\n';
        d.debug.sampleDates.forEach(s=>{
          msg+=s.sheet+': raw="'+s.raw+'" fmt="'+s.formatted+'" isDate='+s.isDate+' match='+s.matchTarget+'\n';
        });
      }
    }
    alert(msg);
    st('‚úÖ API OK','#E8F5E9');
  }catch(e){alert('‚ùå API ERROR: '+e.message);st('‚ùå '+e.message,'#FFEBEE')}
}

// ‡∏ó‡∏î‡∏™‡∏≠‡∏ö POST
async function testPOST(){
  st('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö POST...');
  const testData={action:'addOrder',date:fD(new Date()),time:fT(new Date()),productName:'TEST',amount:1,phone:'0000000000',detail:'TEST POST',adminName:cu?cu.name:'test',addedBy:cu?cu.email:'test'};
  const sent=await PC(testData);
  alert('POST '+(sent?'‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠ 5 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Test API ‡∏î‡∏π)':'‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ!'));
}

// ===== AUTH =====
function doLogin(){
  const em=document.getElementById('lEm').value.trim().toLowerCase();
  const pin=document.getElementById('lPn').value.trim();
  const err=document.getElementById('lErr');
  if(!em||!pin){err.textContent='‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';return}
  err.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
  fetch(API).then(r=>r.json()).then(d=>{
    if(d.users)users=d.users;if(d.products)products=d.products;
    teams=[...new Set(users.map(u=>u.team).filter(Boolean))];
    const u=users.find(x=>x.email===em&&x.pin===pin);
    if(!u){err.textContent='‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠ PIN ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';return}
    cu=u;localStorage.setItem('th_cu',JSON.stringify(cu));err.textContent='';showApp();
  }).catch(()=>{
    const s=localStorage.getItem('th_cu');
    if(s){const j=JSON.parse(s);if(j.email===em&&j.pin===pin){cu=j;showApp();return}}
    err.textContent='‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
  });
}
function doLogout(){cu=null;orders=[];products=[];users=[];localStorage.removeItem('th_cu');document.getElementById('app').style.display='none';document.getElementById('loginPage').style.display='flex'}
function checkS(){const s=localStorage.getItem('th_cu');if(s){cu=JSON.parse(s);showApp()}}

// ===== APP =====
function showApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('tNm').textContent=cu.name;
  const r=document.getElementById('tRl');
  if(cu.role==='boss'){r.textContent='‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤';r.className='rl rl-b'}else{r.textContent='‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô';r.className='rl rl-a'}
  bNav();nav(cu.role==='boss'?'home':'add');
}
function bNav(){
  const b=cu.role==='boss';
  let t=[{id:'home',i:'üè†',l:'‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å'},{id:'add',i:'‚ûï',l:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'},{id:'orders',i:'üìã',l:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'}];
  if(b)t.push({id:'settings',i:'‚öôÔ∏è',l:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'});
  document.getElementById('bNav').innerHTML=t.map(x=>`<button class="nb" id="n-${x.id}" onclick="nav('${x.id}')"><span class="ni">${x.i}</span><span class="nl">${x.l}</span></button>`).join('');
}
function nav(p){
  cPg=p;
  document.querySelectorAll('.pg').forEach(e=>e.classList.remove('ac'));
  document.querySelectorAll('.nb').forEach(e=>e.classList.remove('ac'));
  const pg=document.getElementById('pg-'+p),nb=document.getElementById('n-'+p);
  if(pg)pg.classList.add('ac');if(nb)nb.classList.add('ac');
  if(p==='settings'){rSett();return}
  rP();FC(cu.role==='boss'?bD||null:null);
  window.scrollTo(0,0);
}
function rP(){if(cPg==='home')rHome();if(cPg==='orders')rOrd();if(cPg==='add')rAdd()}

// ===== HOME =====
function rHome(){
  const pg=document.getElementById('pg-home');
  const td=cu.role==='boss'?(bD||fD(new Date())):fD(new Date());
  if(cu.role==='boss'){
    const to=orders.filter(o=>o.date===td);
    const tt=to.reduce((s,o)=>s+o.amount,0);
    const ba={},bt={};
    to.forEach(o=>{
      const k=o.adminName||'?';if(!ba[k])ba[k]={n:k,t:0,c:0,tm:o.team||''};ba[k].t+=o.amount;ba[k].c++;
      const tk=o.team||'‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';if(!bt[tk])bt[tk]={n:tk,t:0,c:0};bt[tk].t+=o.amount;bt[tk].c++;
    });
    let h=`<div style="display:flex;gap:8px;margin-bottom:12px;align-items:center;flex-wrap:wrap">
      <button class="chip ${!bD?'ac':''}" onclick="sD('')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button class="chip" onclick="sD('y')">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
      <input type="date" onchange="sDP(this.value)" style="border:2px solid rgba(180,140,100,.15);border-radius:12px;padding:6px 10px;font-size:13px;font-family:Sarabun;flex:1;min-width:130px">
      <span style="font-size:12px;color:#888">${td}</span>
    </div>
    <div class="card"><h3>üìä ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</h3><div class="big">‡∏ø${tt.toLocaleString()}</div><div class="sub">${to.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ ${td}</div></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0 8px"><span style="font-weight:700;font-size:15px">üë§ ‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</span><button onclick="FC(bD||null)" style="background:none;border:none;font-size:12px;color:var(--brown);cursor:pointer;font-weight:600">üîÑ</button></div>`;
    Object.values(ba).sort((a,b)=>b.t-a.t).forEach(a=>{
      h+=`<div class="ac2"><div><div style="font-weight:700">${a.n}</div><div style="font-size:11px;color:#999">${a.tm}</div></div><div style="text-align:right"><div style="font-weight:800;font-size:18px;color:var(--brown)">‡∏ø${a.t.toLocaleString()}</div><div style="font-size:11px;color:#aaa">${a.c} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div></div></div>`;
    });
    if(Object.keys(bt).length){
      h+=`<span style="font-weight:700;font-size:15px;display:block;margin:20px 0 8px">üë• ‡∏¢‡∏≠‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ó‡∏µ‡∏°</span>`;
      Object.values(bt).sort((a,b)=>b.t-a.t).forEach(t=>{
        h+=`<div class="ac2"><div style="font-weight:700">${t.n}</div><div style="text-align:right"><div style="font-weight:800;font-size:18px;color:var(--brown)">‡∏ø${t.t.toLocaleString()}</div><div style="font-size:11px;color:#aaa">${t.c} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div></div></div>`;
      });
    }
    if(!to.length)h+=`<div style="text-align:center;padding:40px;color:#ccc">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>`;
    pg.innerHTML=h;
  }else{
    const my=orders.filter(o=>o.adminEmail===cu.email||o.adminName===cu.name);
    const to=my.filter(o=>o.date===td);
    const tt=to.reduce((s,o)=>s+o.amount,0);
    const bp={};to.forEach(o=>{const n=o.productName||'?';if(!bp[n])bp[n]={n:n,t:0,c:0};bp[n].t+=o.amount;bp[n].c++});
    let h=`<div class="card"><h3>üìä ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3><div class="big">‡∏ø${tt.toLocaleString()}</div><div class="sub">${to.length} ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ ${td}</div></div>`;
    if(Object.keys(bp).length){
      h+=`<span style="font-size:14px;font-weight:700;display:block;margin:12px 0 8px">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>`;
      Object.values(bp).sort((a,b)=>b.t-a.t).forEach(p=>{
        h+=`<div class="si"><span style="font-weight:600">${p.n} (${p.c})</span><span style="font-weight:700;color:var(--brown)">‡∏ø${p.t.toLocaleString()}</span></div>`;
      });
    }
    if(to.length){
      h+=`<span style="font-size:14px;font-weight:700;display:block;margin:16px 0 8px">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>`;
      to.slice(0,5).forEach(o=>{
        const isPend=o._local?'<span style="background:#FFF3E0;color:#E65100;font-size:9px;padding:1px 6px;border-radius:8px;margin-left:4px">‚è≥‡∏£‡∏≠</span>':'';
        h+=`<div class="oi"><div class="ol"><div class="op">${o.productName}${isPend}</div><div class="od">${o.time} ‚Ä¢ ${o.phone||''}</div></div><div><div class="opr">‡∏ø${o.amount.toLocaleString()}</div></div></div>`;
      });
    }
    pg.innerHTML=h;
  }
}
function sD(m){const n=new Date();if(m==='y')n.setDate(n.getDate()-1);bD=m?fD(n):'';FC(bD||null)}
function sDP(v){if(!v)return;const p=v.split('-');bD=p[2]+'/'+p[1]+'/'+p[0];FC(bD)}

// ===== ADD =====
function rAdd(){
  const pg=document.getElementById('pg-add');const n=new Date();
  let h=`<div class="card" style="padding:14px;text-align:center"><span style="font-size:13px;color:#888">${cu.name} ‚Ä¢ ${fD(n)} ‚Ä¢ <span id="aT">${fT(n)}</span></span></div>
    <span style="font-size:15px;font-weight:700;display:block;margin:12px 0 8px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><div class="pg2">`;
  if(!products.length)h+=`<div style="grid-column:span 2;text-align:center;padding:30px;color:#ccc">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
  else products.forEach(p=>{h+=`<div class="pc ${selP===p.id?'sel':''}" onclick="sePr('${p.id}',this)"><div class="pn">${p.name}</div></div>`});
  h+=`</div><div id="fA" style="display:${selP?'block':'none'}">
    <div class="fg"><label>üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤</label><input class="fi" id="iPr" type="number" inputmode="decimal" placeholder="0"></div>
    <div class="fg"><label>üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏î‡πâ‡∏ß‡∏¢)</label><textarea class="fi" id="iDt" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ 0812345678" oninput="cPh()"></textarea></div>
    <div id="phI"></div>
    <div class="slb" onclick="document.getElementById('slF').click()">üì∏ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</div>
    <input type="file" id="slF" accept="image/*" style="display:none" onchange="hSl(this)">
    <img id="slPv" class="slp" style="display:none">
    <button class="sbtn" id="sBtn" onclick="subO()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>`;
  pg.innerHTML=h;
  if(window._at)clearInterval(window._at);
  window._at=setInterval(()=>{const e=document.getElementById('aT');if(e)e.textContent=fT(new Date())},1000);
}
function sePr(id,el){selP=id;document.querySelectorAll('.pc').forEach(e=>e.classList.remove('sel'));el.classList.add('sel');document.getElementById('fA').style.display='block';document.getElementById('iPr').focus()}
function cPh(){const t=document.getElementById('iDt').value,i=document.getElementById('phI'),m=t.match(/0[689]\d{8}/);
  if(m)i.innerHTML=`<div class="phb ok">üìû ${m[0]}</div>`;else if(t.length>3)i.innerHTML=`<div class="phb err">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</div>`;else i.innerHTML=''}
function hSl(inp){if(!inp.files[0])return;const r=new FileReader();r.onload=e=>{window._slip=e.target.result;document.getElementById('slPv').src=e.target.result;document.getElementById('slPv').style.display='block'};r.readAsDataURL(inp.files[0])}

async function subO(){
  if(!selP)return;const p=products.find(x=>x.id===selP);if(!p)return;
  const pr=parseFloat(document.getElementById('iPr').value)||0;if(!pr){document.getElementById('iPr').focus();return}
  const dt=document.getElementById('iDt').value.trim();if(!dt){document.getElementById('iDt').focus();return}
  const ph=(dt.match(/0[689]\d{8}/)||[''])[0];
  if(!ph){st('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ 10 ‡∏´‡∏•‡∏±‡∏Å','#FFEBEE');document.getElementById('iDt').focus();return}
  const btn=document.getElementById('sBtn');btn.disabled=true;btn.textContent='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  const n=new Date(),sl=window._slip||'';
  const o={date:fD(n),time:fT(n),productName:p.name,price:pr,amount:pr,phone:ph,detail:dt,addedBy:cu.email,adminName:cu.name,adminEmail:cu.email,team:cu.team,_local:true,_ts:Date.now()};
  orders.unshift(o);
  // ‡∏™‡πà‡∏á‡πÑ‡∏õ Cloud (‡∏£‡∏≠‡∏à‡∏ô‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à)
  const sent=await PC({action:'addOrder',...o,slip:sl});
  selP=null;window._slip=null;
  if(sent){
    sS('‚úÖ','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',p.name+' ‡∏ø'+pr.toLocaleString()+(ph?' | üìû'+ph:''));
  }else{
    sS('‚ö†Ô∏è','‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏™‡πà‡∏á Cloud)',p.name+' ‡∏ø'+pr.toLocaleString());
  }
  setTimeout(()=>{hS();rAdd()},1200);
  // ‡∏î‡∏∂‡∏á Cloud ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏à‡∏≠
  [3000,8000,20000,40000].forEach(ms=>setTimeout(()=>FC(),ms));
}

// ===== ORDERS =====
function rOrd(){
  const pg=document.getElementById('pg-orders');
  const td=cu.role==='boss'?(bD||fD(new Date())):fD(new Date());
  let mo;
  if(cu.role==='boss')mo=orders.filter(o=>o.date===td);
  else mo=orders.filter(o=>(o.adminEmail===cu.email||o.adminName===cu.name)&&o.date===td);
  const pns=['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',...new Set(mo.map(o=>o.productName).filter(Boolean))];
  if(fProd!=='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')mo=mo.filter(o=>o.productName===fProd);
  let ans=[];
  if(cu.role==='boss'){ans=['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',...new Set(orders.filter(o=>o.date===td).map(o=>o.adminName).filter(Boolean))];if(fAdm!=='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î')mo=mo.filter(o=>o.adminName===fAdm)}
  const tt=mo.reduce((s,o)=>s+o.amount,0);
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span style="font-weight:700;font-size:16px">üìã ${td}</span><button onclick="FC(${cu.role==='boss'?'bD||null':'null'})" style="background:none;border:none;font-size:12px;color:var(--brown);cursor:pointer;font-weight:600">üîÑ</button></div>
    <div class="card" style="padding:14px;display:flex;justify-content:space-between"><span style="font-weight:600">${mo.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span><span style="font-weight:800;color:var(--brown)">‡∏ø${tt.toLocaleString()}</span></div>
    <div class="chips">${pns.map(n=>`<div class="chip ${fProd===n?'ac':''}" onclick="fProd='${n}';rOrd()">${n}</div>`).join('')}</div>`;
  if(cu.role==='boss'&&ans.length>1)h+=`<div class="chips">${ans.map(n=>`<div class="chip ${fAdm===n?'ac':''}" onclick="fAdm='${n}';rOrd()">${n}</div>`).join('')}</div>`;
  if(!mo.length)h+=`<div style="text-align:center;padding:40px;color:#ccc">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
  else mo.forEach(o=>{
    const isPend=o._local?'<span style="background:#FFF3E0;color:#E65100;font-size:9px;padding:1px 6px;border-radius:8px;margin-left:4px">‚è≥‡∏£‡∏≠</span>':'';
    h+=`<div class="oi"><div class="ol"><div class="op">${o.productName} ${o.slip?'üì∏':''}${isPend}</div><div class="od">${o.time} ‚Ä¢ ${o.phone||'-'} ${cu.role==='boss'?'‚Ä¢ '+o.adminName:''}</div></div><div><div class="opr">‡∏ø${o.amount.toLocaleString()}</div><div class="on">#${o.dailyNo||'-'}</div></div></div>`;
  });
  pg.innerHTML=h;
}

// ===== SETTINGS =====
function rSett(){
  const pg=document.getElementById('pg-settings');
  let h=`<span style="font-size:16px;font-weight:700;display:block;margin-bottom:12px">üß¥ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
    <button class="abtn" onclick="shAP()" style="margin-bottom:12px">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>`;
  products.forEach(p=>{h+=`<div class="si"><span style="font-weight:600">${p.name}</span><button class="dbtn" onclick="dP('${p.id}')">üóëÔ∏è</button></div>`});
  h+=`<span style="font-size:16px;font-weight:700;display:block;margin:24px 0 12px">üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
    <button class="abtn" onclick="shAM()" style="margin-bottom:12px">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>`;
  users.filter(u=>u.role==='admin').forEach(u=>{
    h+=`<div class="si"><div><span style="font-weight:600">${u.name}</span> <span class="tb">${u.team||'-'}</span><div style="font-size:11px;color:#aaa">${u.email}</div></div><button class="dbtn" onclick="dM('${u.email}')">üóëÔ∏è</button></div>`;
  });
  h+=`<span style="font-size:16px;font-weight:700;display:block;margin:24px 0 12px">üè∑Ô∏è ‡∏ó‡∏µ‡∏°</span>`;
  teams.forEach(t=>{h+=`<div class="si"><span style="font-weight:600">${t}</span></div>`});
  h+=`<div style="margin-top:30px;text-align:center"><button onclick="FC()" style="background:none;border:1px solid var(--brown);color:var(--brown);border-radius:12px;padding:10px 20px;cursor:pointer;font-weight:600;font-size:13px">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button></div>
  <div style="margin-top:12px;text-align:center"><button onclick="testAPI()" style="background:#E3F2FD;border:none;border-radius:12px;padding:8px 16px;cursor:pointer;font-size:12px;color:#1565C0;font-weight:600">üîç Test API</button> <button onclick="testPOST()" style="background:#FFF3E0;border:none;border-radius:12px;padding:8px 16px;cursor:pointer;font-size:12px;color:#E65100;font-weight:600">üì§ Test POST</button></div>
  <div style="text-align:center;margin-top:16px;color:#ccc;font-size:11px">${VER}</div>`;
  pg.innerHTML=h;
  // ‡∏î‡∏∂‡∏á Cloud ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
  FC();
}
function shAP(){oM(`<h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3><input class="fi" id="nPN" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"><button class="sbtn" onclick="aP()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>`)}
function aP(){const n=document.getElementById('nPN').value.trim();if(!n)return;products.push({id:'p'+Date.now(),name:n});PC({action:'saveProducts',products});cM();rSett();sS('‚úÖ','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',n);setTimeout(hS,1200)}
function dP(id){const p=products.find(x=>x.id===id);if(!p||!confirm('‡∏•‡∏ö "'+p.name+'" ?'))return;products=products.filter(x=>x.id!==id);PC({action:'saveProducts',products});rSett()}
function shAM(){oM(`<h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3><input class="fi" id="mN" placeholder="‡∏ä‡∏∑‡πà‡∏≠" style="margin-bottom:8px"><input class="fi" id="mE" type="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" style="margin-bottom:8px"><input class="fi" id="mP" type="text" inputmode="numeric" maxlength="4" placeholder="PIN 4 ‡∏´‡∏•‡∏±‡∏Å" style="margin-bottom:8px"><select class="fi" id="mT">${teams.map(t=>`<option>${t}</option>`).join('')}<option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option></select><div id="mEr" style="color:var(--rd);font-size:13px;margin-top:6px"></div><button class="sbtn" onclick="aM()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>`)}
function aM(){const n=document.getElementById('mN').value.trim(),e=document.getElementById('mE').value.trim().toLowerCase(),p=document.getElementById('mP').value.trim(),t=document.getElementById('mT').value,er=document.getElementById('mEr');
  if(!n||!e||!p){er.textContent='‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';return}if(p.length!==4){er.textContent='PIN 4 ‡∏´‡∏•‡∏±‡∏Å';return}if(users.find(u=>u.email===e)){er.textContent='‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ã‡πâ‡∏≥';return}
  users.push({email:e,pin:p,name:n,role:'admin',team:t});teams=[...new Set(users.map(u=>u.team).filter(Boolean))];PC({action:'saveUsers',users});cM();rSett();sS('‚úÖ','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!',n);setTimeout(hS,1200)}
function dM(em){const u=users.find(x=>x.email===em);if(!u||u.role==='boss'||!confirm('‡∏•‡∏ö "'+u.name+'" ?'))return;users=users.filter(x=>x.email!==em);PC({action:'saveUsers',users});rSett()}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
  if('serviceWorker' in navigator)navigator.serviceWorker.getRegistrations().then(r=>{r.forEach(w=>w.unregister())});
  document.getElementById('lPn').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
  document.getElementById('lEm').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('lPn').focus()});
  checkS();
  setInterval(()=>{if(cu)FC(cu.role==='boss'?bD||null:null)},45000);
});
</script>
</body>
</html>
